#!/usr/bin/env bash
# Usage: bin/compile BUILD_DIR CACHE_DIR ENV_DIR
# For example: bin/compile /var/dummy_app /var/buildpack_cache /var/buildpack_env
# https://devcenter.heroku.com/articles/buildpack-api#bin-compile

set -e

BUILDPACK_DIR=$(pwd)
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
VENDOR_GEM_NAME=$(cat $ENV_DIR/VENDOR_GEM_NAME)
COMMON_GEM_URL=$(cat $ENV_DIR/COMMON_GEM_URL)
# echo "-----> vendor-gem-buildpack: BUILDPACK_DIR=$BUILDPACK_DIR BUILD_DIR=$BUILD_DIR CACHE_DIR=$CACHE_DIR ENV_DIR=$ENV_DIR"

# TODO: replace the sha with a sha from Gemfile.lock
curl -O -L $COMMON_GEM_URL/archive/ac0c75dc3f2b586509300ffdf0ae338c484ccf72.zip
unzip -q ac0c75dc3f2b586509300ffdf0ae338c484ccf72.zip
mkdir -p $BUILD_DIR/$VENDOR_GEM_NAME
mv hivewebshop-ac0c75dc3f2b586509300ffdf0ae338c484ccf72/$VENDOR_GEM_NAME $BUILD_DIR/$VENDOR_GEM_NAME/
touch $BUILD_DIR/.use_local_$VENDOR_GEM_NAME
rm -rf ac0c75dc3f2b586509300ffdf0ae338c484ccf72.zip hivewebshop-ac0c75dc3f2b586509300ffdf0ae338c484ccf72
echo "-----> vendor-gem-buildpack: vendored $VENDOR_GEM_NAME gem into app/$VENDOR_GEM_NAME"

exit 0
